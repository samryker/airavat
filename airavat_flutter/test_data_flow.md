# Airavat Data Flow Structure

## Complete Patient Journey Flow

### 1. Patient Signup & Profile Creation
**Location**: `account_screen.dart` → `_saveProfile()`
**Firestore Collection**: `patients/{userId}`

```dart
{
  'email': user.email,
  'bmiIndex': bmiIndex,
  'medicines': medicines,
  'allergies': allergies,
  'history': history,
  'goal': goal,
  'age': age,
  'race': race,
  'gender': gender,
  'habits': ['Smoking', 'Alcohol Abuse'],
  'treatmentPlans': [
    {
      'treatmentName': 'Initial Treatment',
      'condition': 'Diabetes',
      'startDate': '2024-01-01T00:00:00.000Z',
      'status': 'active'
    }
  ],
  'updatedAt': ServerTimestamp()
}
```

### 2. Dashboard Display
**Location**: `dashboard_screen.dart` → `_loadTreatmentHistory()`
**Data Sources**: 
- `patients/{userId}` - Historical treatments
- `latest_treatment/{userId}` - Most recent treatment

### 3. Chat Assistant Treatment Saving
**Location**: `chat_page.dart` → `_updateTreatmentInFirebase()`
**Logic**: 

#### Same Day (Append):
- Checks if treatment exists from today
- If YES: Appends to `patients/{userId}.treatmentPlans` array
- Updates `patients/{userId}.lastTreatmentUpdate`

#### Different Day (New Latest):
- Adds to `patients/{userId}.treatmentPlans` array
- **Creates/Updates** `latest_treatment/{userId}`:
```dart
{
  'patient_id': userId,
  'treatment_data': {
    'treatmentName': 'AI Medical Guidance',
    'condition': 'Generated by Gemini AI',
    'treatment_text': 'Full Gemini analysis response...',
    'timestamp': '2024-01-15T10:30:00.000Z',
    'request_id': 'req_123',
    'type': 'gemini_treatment_update',
    'source': 'ai_assistant',
    'plan_type': 'ai_guidance',
    'priority': 'medium'
  },
  'created_at': ServerTimestamp(),
  'date': '2024-01-15'
}
```

### 4. Gemini Context Loading
**Location**: `api_service.dart` → `getPatientContext()`
**Returns**: Combined data from both collections:

```dart
{
  // From patients/{userId}
  'email': 'user@example.com',
  'bmiIndex': '23.5',
  'medicines': 'Metformin 500mg',
  'treatmentPlans': [...], // Historical treatments
  
  // From latest_treatment/{userId}
  'latest_treatment': {
    'treatment_text': 'Latest Gemini analysis...',
    'timestamp': '2024-01-15T10:30:00.000Z',
    // ... other treatment data
  },
  'latest_treatment_date': '2024-01-15'
}
```

## Firestore Collections Structure

### Collection: `patients`
```
patients/
  {userId}/
    - email: string
    - bmiIndex: string
    - medicines: string
    - allergies: string
    - history: string
    - goal: string
    - age: number
    - race: string
    - gender: string
    - habits: string[]
    - treatmentPlans: object[]
    - updatedAt: timestamp
    - lastTreatmentUpdate: timestamp
```

### Collection: `latest_treatment`
```
latest_treatment/
  {userId}/
    - patient_id: string
    - treatment_data: object
    - created_at: timestamp
    - date: string (YYYY-MM-DD)
```

## Benefits of This Structure

1. **Single Source for Patient Profile**: All basic patient data in one document
2. **Efficient Latest Treatment Access**: Gemini gets immediate access to most recent guidance
3. **Historical Tracking**: All treatments preserved in chronological order
4. **Same-Day Append Logic**: Multiple treatments on same day are grouped
5. **Unified Data Store**: No separate datastores - everything in Firestore
6. **Login Persistence**: Latest treatment automatically loaded when user returns

## UI Enhancements

- **Dashboard**: Latest treatment highlighted with gold star and "LATEST" badge
- **Chat**: Beautiful treatment save prompt with loading states
- **Context**: Automatic patient context loading for Gemini responses 