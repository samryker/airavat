<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>3D Digital Twin (SMPL)</title>
    <style>
      html, body { height: 100%; }
      body {
        margin: 0;
        overflow: hidden;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        background: linear-gradient(135deg, #ffffff 0%, #fff7cc 40%, #d9fbe6 100%);
      }
      /* Hide built-in UI; controls come from Flutter */
      #ui { display: none; }
      #ui h4 { margin: 0 0 8px 0; font-size: 14px; }
      #ui .row { display: flex; gap: 8px; align-items: center; margin: 6px 0; }
      #ui label { font-size: 12px; width: 64px; color: #333; }
      #ui select, #ui input[type=number], #ui input[type=range] { font-size: 12px; }
      #status { position: absolute; top: 10px; right: 10px; z-index: 10; padding: 10px; background: rgba(0,0,0,0.75); color: #fff; border-radius: 8px; font-size: 12px; min-width: 200px; }
      .btn { background: #0ea5e9; border: none; color: #fff; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; }
      .btn:disabled { background: #9ca3af; cursor: default; }
    </style>
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.172.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.172.0/examples/jsm/"
        }
      }
    </script>
</head>
<body>
  <div id="ui">
    <h4>SMPL Controls</h4>
    <div class="row">
      <label>Model</label>
      <select id="model">
        <option value="neutral">Neutral</option>
        <option value="male">Male</option>
        <option value="female">Female</option>
      </select>
    </div>
    <div class="row">
      <label>Height</label>
      <input id="height" type="range" min="140" max="200" step="1" value="170"/>
      <input id="heightNum" type="number" min="140" max="200" step="1" value="170" style="width:60px"/>
      <span>cm</span>
    </div>
    <div class="row">
      <label>Weight</label>
      <input id="weight" type="range" min="45" max="120" step="1" value="70"/>
      <input id="weightNum" type="number" min="45" max="120" step="1" value="70" style="width:60px"/>
      <span>kg</span>
    </div>
    <div class="row">
      <label>Beta1</label>
      <input id="beta1" type="range" min="0" max="1" step="0.01" value="0.4"/>
      <input id="beta1Num" type="number" min="0" max="1" step="0.01" value="0.4" style="width:60px"/>
    </div>
    <div class="row">
      <button id="apply" class="btn">Apply</button>
    </div>
  </div>
  <div id="status">Initializing...</div>

  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    const SMPL_API_BASE = 'https://airavat-backend-f255cpkfda-uc.a.run.app';
    const SMPL_ASSETS_BASE_URL = 'https://storage.googleapis.com/mira-smpl-assets/models';

    let scene, camera, renderer, controls;
    let currentMesh = null;

    const modelSel = document.getElementById('model');
    const heightR = document.getElementById('height');
    const heightN = document.getElementById('heightNum');
    const weightR = document.getElementById('weight');
    const weightN = document.getElementById('weightNum');
    const beta1R = document.getElementById('beta1');
    const beta1N = document.getElementById('beta1Num');

    init();
    fetchAndLoad();
    const applyBtn = document.getElementById('apply');

    heightR?.addEventListener('input', () => heightN.value = heightR.value);
    heightN?.addEventListener('input', () => heightR.value = heightN.value);
    weightR?.addEventListener('input', () => weightN.value = weightR.value);
    weightN?.addEventListener('input', () => weightR.value = weightN.value);
    beta1R?.addEventListener('input', () => beta1N.value = beta1R.value);
    beta1N?.addEventListener('input', () => beta1R.value = beta1N.value);

    modelSel?.addEventListener('change', fetchAndLoad);
    applyBtn?.addEventListener('click', fetchAndLoad);

    window.addEventListener('message', async (evt) => {
      const data = evt?.data || {};
      if (data?.type === 'smpl:update') {
        const p = data.payload || {};
        if (p.gender) modelSel.value = p.gender;
        if (p.height) heightR.value = heightN.value = p.height;
        if (p.weight) weightR.value = weightN.value = p.weight;
        if (typeof p.beta1 === 'number') beta1R.value = beta1N.value = p.beta1;
        await fetchAndLoad();
      }
    });

    async function fetchAndLoad() {
      const model = modelSel?.value || 'neutral';
      const height = Number(heightR?.value || 170);
      const weight = Number(weightR?.value || 70);
      const beta1 = Number(beta1R?.value || 0.4);
      setStatus('Loading SMPL...');
      
      try {
        // Try to get signed URL from backend first with proper CORS handling
        const params = new URLSearchParams({
          patient_id: 'viewer',
          height: String(height),
          weight: String(weight),
          gender: model,
          model: model,
          beta1: String(beta1)
        });
        
        // First try with /api rewrite path (Firebase Hosting)
        let response = null;
        let backendUrl = `/api/smpl/generate?${params.toString()}`;
        
        try {
          response = await fetch(backendUrl, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
            },
            mode: 'cors',
            credentials: 'omit'
          });
          
          if (response.ok) {
            const data = await response.json();
            if (data.asset_url) {
              await loadGLB(data.asset_url, data.parameters);
              setStatus(`Loaded ${model}.glb via Firebase rewrite`);
              return;
            }
          }
        } catch (rewriteError) {
          console.log('Firebase rewrite failed, trying direct Cloud Run:', rewriteError);
        }
        
        // Fallback to direct Cloud Run URL
        try {
          backendUrl = `${SMPL_API_BASE}/smpl/generate?${params.toString()}`;
          response = await fetch(backendUrl, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
            },
            mode: 'cors',
            credentials: 'omit'
          });
          
          if (response.ok) {
            const data = await response.json();
            if (data.asset_url) {
              await loadGLB(data.asset_url, data.parameters);
              setStatus(`Loaded ${model}.glb via direct backend`);
              return;
            }
          }
        } catch (directError) {
          console.log('Direct Cloud Run failed:', directError);
        }
        
        // Fallback to direct GCS access
        const glbUrl = `${SMPL_ASSETS_BASE_URL}/${model}.glb`;
        const parameters = {
          height_cm: height,
          weight_kg: weight,
          gender: model,
          beta1: beta1,
          bmi: height > 0 ? Math.round(weight / ((height / 100.0) ** 2) * 10) / 10 : null
        };
        
        try {
          await loadGLB(glbUrl, parameters);
          setStatus(`Loaded ${model}.glb from GCS fallback`);
          return;
        } catch (gcsError) {
          console.log('GCS access failed:', gcsError);
        }
        
        // Final fallback to placeholder
        await loadPlaceholder(parameters);
        setStatus('Loaded placeholder (all sources failed)');
        
      } catch (e) {
        console.error('Error loading SMPL:', e);
        try {
          const parameters = {
            height_cm: height,
            weight_kg: weight,
            gender: model,
            beta1: beta1
          };
          await loadPlaceholder(parameters);
          setStatus('Loaded placeholder (error occurred)');
        } catch (fallbackError) {
          console.error('Fallback also failed:', fallbackError);
          setStatus('Error loading SMPL');
        }
      }
    }

    async function loadGLB(url, parameters) {
      const loader = new GLTFLoader();
      const gltf = await loader.loadAsync(url);
      if (currentMesh) scene.remove(currentMesh);
      const root = gltf.scene || gltf.scenes?.[0];
      if (!root) throw new Error('No scene in GLB');

      const h = parameters?.height_cm ?? 170;
      const w = parameters?.weight_kg ?? 70;
      const overall = 2.2; // slightly taller overall scale for vertical framing
      const hScale = h / 170.0;
      const wScale = w / 70.0;
      root.scale.set(overall * wScale, overall * hScale, overall * wScale);

      const beta1 = typeof parameters?.beta1 === 'number' ? parameters.beta1 : undefined;
      if (typeof beta1 === 'number') {
        root.traverse(obj => {
          if (obj.morphTargetInfluences) {
            obj.morphTargetInfluences[0] = Math.max(0, Math.min(1, beta1));
          }
        });
      }

      scene.add(root);
      currentMesh = root;
    }

    async function loadPlaceholder(parameters) {
      if (currentMesh) scene.remove(currentMesh);
      const group = new THREE.Group();
      const h = parameters?.height_cm ?? 170;
      const w = parameters?.weight_kg ?? 70;
      const hScale = h / 170.0;
      const wScale = w / 70.0;
      const overall = 2.2;
      const torso = new THREE.Mesh(
        new THREE.CylinderGeometry(0.28 * wScale * overall, 0.23 * wScale * overall, 0.9 * hScale * overall, 32),
        new THREE.MeshPhongMaterial({ color: 0x4a90e2, shininess: 30 })
      );
      torso.position.y = 1.2 * hScale * overall;
      group.add(torso);
      scene.add(group);
      currentMesh = group;
    }

    function init() {
      scene = new THREE.Scene();
      scene.background = null;
      camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 2.2, 5.2); // higher Y, a bit closer Z for vertical framing
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      const amb = new THREE.AmbientLight(0xffffff, 0.95);
      scene.add(amb);
      const dir = new THREE.DirectionalLight(0xffffff, 1.2);
      dir.position.set(5, 10, 7.5);
      scene.add(dir);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.minDistance = 2.0;
      controls.maxDistance = 10.0; // tighter zoom range
      controls.maxPolarAngle = Math.PI * 0.55; // limit tilt for portrait view

      window.addEventListener('resize', onResize);
      (function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); })();
    }

    function onResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function setStatus(text) {
      const el = document.getElementById('status');
      if (el) el.textContent = text;
    }

    window.loadSMPLAvatar = async function(patientId, height, weight, gender, opts={}) {
      if (gender) modelSel.value = gender;
      if (height) heightR.value = heightN.value = height;
      if (weight) weightR.value = weightN.value = weight;
      if (opts.beta1 !== undefined) beta1R.value = beta1N.value = opts.beta1;
      await fetchAndLoad();
    }
    window.updateSMPLParameters = async function(height, weight, gender, opts={}) {
      if (gender) modelSel.value = gender;
      if (height) heightR.value = heightN.value = height;
      if (weight) weightR.value = weightN.value = weight;
      if (opts.beta1 !== undefined) beta1R.value = beta1N.value = opts.beta1;
      await fetchAndLoad();
    }
    window.getSMPLHealth = async function() {
      // Check if GCS assets are accessible
      try {
        const testUrl = `${SMPL_ASSETS_BASE_URL}/male.glb`;
        const response = await fetch(testUrl, { method: 'HEAD' });
        return response.ok ? { status: 'ok', assets_available: true } : { status: 'error', assets_available: false };
      } catch (e) {
        return { status: 'error', assets_available: false, error: e.message };
      }
    }
  </script>
</body>
</html>
